name: Release Extension

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run typecheck

      - name: Build TypeScript
        run: npm run build

      - name: Verify build
        run: |
          if [ ! -f "dist/mcp-server.js" ]; then
            echo "Build failed: dist/mcp-server.js not found"
            exit 1
          fi
          echo "Build successful!"

      - name: Create release archive
        run: |
          mkdir -p release
          
          # Create archive with all necessary files
          tar -czvf release/gemini-ralph-loop.tar.gz \
            --transform 's,^,gemini-ralph-loop/,' \
            gemini-extension.json \
            GEMINI.md \
            package.json \
            package-lock.json \
            commands/ \
            dist/ \
            README.md \
            LICENSE

      - name: Generate release notes
        id: release_notes
        run: |
          echo "## What's New" > release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo 'gemini extensions install https://github.com/kranthik123/Gemini-Ralph-Loop' >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "### Commands Available" >> release_notes.md
          echo "- \`/ralph:start-loop\` - Start a new loop" >> release_notes.md
          echo "- \`/ralph:status\` - Check status" >> release_notes.md
          echo "- \`/ralph:monitor\` - Real-time monitoring" >> release_notes.md
          echo "- \`/ralph:pause\` / \`/ralph:resume\` - Control loop" >> release_notes.md
          echo "- \`/ralph:checkpoint\` / \`/ralph:restore\` - Save/restore state" >> release_notes.md
          echo "- \`/ralph:help\` - Full command list" >> release_notes.md
          echo "" >> release_notes.md
          echo "See [README](https://github.com/kranthik123/Gemini-Ralph-Loop#readme) for full documentation." >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/gemini-ralph-loop.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Notify on release
  notify:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Release notification
        run: |
          echo "ðŸŽ‰ Release ${{ github.ref_name }} published successfully!"
          echo "Install with: gemini extensions install https://github.com/kranthik123/Gemini-Ralph-Loop"